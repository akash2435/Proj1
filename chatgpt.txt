define(['plugins/router', 'durandal/app', 'services/security', 'global/session', 'services/logger', 'jquery', 'knockout', 'loginModel', 'knockout.validation', 'plugins/http', 'jquerycapslock', 'config', 'shell', 'register', 'header', 'siteAnnouncementModel', 'pendingApprovalService', 'alertNotification'],
    function (router, app, security, session, logger, $, ko, loginModel, validation, https, jquerycapslock, config, shell, registerModule, header, siteAnnouncementModel, pendingApprovalService, alerter) {
        var loginModel = new loginModel.login();
        var announcementsList = ko.observable([]);
        var pendingApprovals = ko.observable([]);
        var carouselView = ko.observable('AlamoCarousel.html');
        var sublinkData = ko.observable();
        var subLinkDatadivClass = ko.observable(0);
        var orderId = ko.observable();
        var loginError = ko.observable('');
        var isApproved = ko.observable('');
        var userInfo;
        var userSecurityInfo;
        var isNewLLAEntry;
        var showSiteAnnouncements = ko.observable(false);
        var isLoggedIn = ko.observable(false);
        var oktaSignIn = null;

        var subLinkDataCSS = ko.computed(function () {
            switch (subLinkDatadivClass()) {
                case 4:
                    return 'col-6 col-sm-6 col-md-3';
                case 3:
                    return 'col-6 col-sm-4';
                case 2:
                    return 'col-6 col-sm-6';
            }
        });

        var brandServicesName = ko.computed(function () {
            var brandId = $('.currentBrand').val();
            switch (parseInt(brandId)) {
                case 4:
                    return 'Chicago Title Premier Services';
                case 1:
                    return 'Security Union OneSource';
                case 2:
                    return 'Ticor Title Express';
                case 3:
                    return 'Fidelity Passport';
                case 5:
                    return 'Alamo Title Advantage';
                case 7:
                    return 'Global Premier Services';
                case 12:
                    return 'Grand Canyon Title Agency';
                case 15:
                    return 'Commonwealth Land Title';
                case 16:
                    return 'Lawyers Title';
                case 19:
                    return 'Security Title Gateway';
                case 21:
                    return 'Austin Title Access';
                case 23:
                    return 'Western Title Profile';
                case 24:
                    return 'Dane County Title All Access';
                case 26:
                    return 'Global Premier Services';
                case 27:
                    return 'Title Guaranty All Access';
                case 28:
                    return 'Heritage Title Company';
            }
        });

        var carouselFullPath = ko.computed(function () {
            return 'carousel/' + carouselView();
        }, this);

        // Internal properties and functions
        function ExternalLoginProviderViewModel(data) {
            var self = this;

            // Data
            self.name = ko.observable(data.name);

            // Operations
            self.login = function () {
                sessionStorage["state"] = data.state;
                sessionStorage["loginUrl"] = data.url;
                sessionStorage["externalLogin"] = true;
                // IE doesn't reliably persist sessionStorage when navigating to another URL. Move sessionStorage temporarily
                // to localStorage to work around this problem.
                session.archiveSessionStorageToLocalStorage();
                window.location = data.url;
            };
        }

        function reset() {

            session.clearAccessToken();
            session.clearACSFToken();
            vm.loginModel.userName("");
            vm.loginModel.password("");
            vm.loginModel.rememberMe(false);
            vm.setFocus(true);
            vm.validationErrors.showAllMessages(false);
            loginError('');
        }


        function resetControls() {
            $('#LoginUserName').val('');
            $('#LoginPassword').val('');
            vm.loginModel.userName("");
            vm.loginModel.password("");
        }

        // Reveal the bindable properties and functions
        var vm = {
            activate: activate,
            bindingComplete: configOKTA,
            canActivate: canActivate,
            deactivate: resetControls,
            canDeactivate: canDeactivate,
            goBack: goBack,
            title: 'login',
            session: session,
            setFocus: ko.observable(true),
            loginModel: loginModel,
            brands: [new Brand('Chicago Title', '1'), new Brand('Ticor Title', '2')],
            brand: ko.observable(),
            externalLoginProviders: ko.observableArray(),
            loaded: false,
            login: login,
            oktaLogin: oktaLogin,
            register: register,
            attached: AfterLoad,
            forgotPassword: forgotPassword,
            password_mouseout: password_mouseout,
            forgotpassword_mouseout: forgotpassword_mouseout,
            handleKeyUp: handleKeyUp,
            compositionComplete: BindCarousel,
            carouselFullPath: carouselFullPath,
            sublinkData: sublinkData,
            loginError: loginError,
            onBlurEmail: onBlurEmail,
            isApproved: isApproved,
            orderId: orderId,
            LLAAccepted: LLAAccepted,
            LLANotAccepted: LLANotAccepted,
            getPasswordChangeAlert: getPasswordChangeAlert,
            updateUserLastActivity: updateUserLastActivity,
            subLinkDataCSS: subLinkDataCSS,
            displayAnnouncements: displayAnnouncements,
            //announcementModel: announcementModel,
            announcementsList: announcementsList,
            showAnnouncementsModal: showAnnouncementsModal,
            showSiteAnnouncements: showSiteAnnouncements,
            pendingApprovals: pendingApprovals,
            session: session,
            showError: showError,
            brandServicesName: brandServicesName,
            ViewModel: ViewModel


        };
    function ViewModel() {
        var self = this;

        self.showModal = ko.observable(false);

        oktaSignIn = new oktaSignIn({
            baseUrl: 'https://inhere.oktapreview.com',
            clientId: '0oa1f55pq7aDRsJGm0h8',
            redirectUri: 'https://local.premier.ctic.com',
            authParams: {
                issuer: 'https://inhere.oktapreview.com/oauth2/aus1wpcyw6uUCSPMn0h8',
                responseType: ['token', 'id_token'],
                display: 'page',
            }
        });

        self.openLoginModal = function () {
            self.showModal(true);
            oktaSignIn.renderEl(
                { el: '#okta-login-container' },
                function success(res) {
                    if (res.status === 'SUCCESS') {
                        oktaSignIn.authClient.tokenManager.add('accessToken', res.tokens.accessToken);
                        oktaSignIn.authClient.tokenManager.add('idToken', res.tokens.idToken);
                        window.location.href = '{https://local.premier.ctic.com}';
                    }
                },
                function error(err) {
                    console.error("Logginf Error : ", err);
                }
            );
        };

        self.closeModal = function () {
            self.showModal(false);
        };
    }
    ko.applyBindings(new ViewModel());
});
===================================
<input type="hidden" id="hdnIsLogin" value="true" />

<meta http-equiv="Cache-control" content="no-store, no-cache, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="-1">

<div data-bind="visible:(session.isLoggedIn()==false)">
    <div class="row themeColorBorderBottom">
        <div class="col-12 px-0">
            <div class="d-none d-md-block" data-bind="compose:carouselFullPath"></div>
            <div class="Carousel-position">
                <div class="container-fluid">
                    <div class="row justify-content-end">
                        <div class="col-12 mobileBG" data-bind="css:{ 'col-lg-4 col-md-5' : session.deviceType() === 'desktop', 'col-lg-5 col-md-6' : session.deviceType() !== 'desktop'}">
                            <!--<div class="loginContainer" data-bind="visible:(session.isLoggedIn()==false && session.useOktaAuthentication()==true)" >-->
                            <!--<form method="POST">
                                <input type="hidden" name="sessionToken" id="hiddenSessionTokenField" />
                            </form>-->
                            <!--<div id="okta-login-container"></div>-->
                            <!--<div>
                                <asp:Label ID="lblAlertMsg" runat="server" Text="" CssClass="loginErrorMsg"></asp:Label>
                            </div>-->
                            <!--</div>-->
                            <!--<div class="loginContainer" data-bind="visible:(session.isLoggedIn()==false && session.useOktaAuthentication()==false)">-->
                            <div class="loginContainer">
                                <div class="login-panel pt-4 pb-2">
                                    <!--<form class="form-horizontal" role="form" autocomplete="off" method="post">-->
                                    <h1 class="text-center LoginPanelHead">Customers Log In Here</h1>
                                    <div class="text-center pt-1 pb-2">
                                        <span class="LoginPanelSubHead">Everything You Need In One Place</span>
                                    </div>
                                    <div class="text-center">
                                        <span class="required text-center" data-bind="text:loginError"></span>
                                    </div>
                                    <!--<div class="row my-2">
                                        <div class="col-12">
                                            <div class="form-group mb-1">
                                                <label for="LoginUserName">Email</label>
                                                <input type="email" id="LoginUserName" autocomplete="off" class="form-control GPSSecondaryFont" maxlength="75" data-bind="textInput: loginModel.userName, hasFocus: setFocus,event: {blur:onBlurEmail}" />
                                            </div>
                                        </div>
                                    </div>-->
                                    <!--<div class="row my-2">
                                        <div class="col-12">
                                            <label for="LoginPassword">Password</label>
                                            <input type="password" id="LoginPassword" autocomplete="off" class="form-control GPSSecondaryFont loginPassword" maxlength="128" data-bind="textInput: loginModel.password, event: {keyup:handleKeyUp}" formmethod="post"/>
                                            <div id="capsPasswordWarning" style="display:none; color: red;">Caps Lock is on.</div>
                                            <div id="maxPasswordLength" style="display:none; color: red;">Max length of 128 chars. has been reached. Additional characters will be truncated.</div>
                                        </div>
                                    </div>-->
                                    <!--<div class="row justify-content-between py-2">
                                    <div class="col-6 text-left input-group">
                                        <input type="checkbox" id="LoginRememberMe" data-bind="checked: loginModel.rememberMe" aria-label="Remember me" />
                                        <span class="LoginPanelRememberMe">&nbsp; Remember me</span>
                                    </div>-->
                                    <!--<div class="col-6 text-right">
                                        <a href="#" id="forgotPasswordlnk" class="LoginPanelForgotPwd" data-bind="click: forgotPassword,event: {mouseout: forgotpassword_mouseout }">Forgot Password?</a>
                                    </div>-->
                                    <!--</div>-->
                                    <div class="row mb-2">
                                        <div class="col-12">
                                            <!--<button type="button" formmethod="post" class="btn btn-primary btn-block btnLogin" data-bind="click: login, disable: session.isBusy()"><i class="fa fa-lock"></i> LOG IN</button>-->
                                            <button type="button" class="btn btn-primary btn-block" data-bind="click:openLoginModal"><i class="fa fa-lock"></i> LOG IN</button>
                                        </div>
                                    </div>
                                    <!--<div class="row mb-2">
                                    <div class="col-12">-->
                                    <!--ko if:(showSiteAnnouncements())-->
                                    <!--ko if:!(session.isBusy())-->
                                    <!--<div class="text-center" data-bind="css: { active: !(session.isBusy()) }">
                                        <a href="" data-bind="click:showAnnouncementsModal" class="text-danger font-weight-bold"><u>Important Announcements</u></a>
                                    </div>-->
                                    <!--/ko-->
                                    <!--/ko-->
                                    <!--ko if:(session.isBusy())-->
                                    <!--<div class="loader text-center" data-bind="css: { active: session.isBusy() }">
                                        <i class="fa fa-spinner fa-2x fa-spin"></i> <span class="">Please Wait</span>
                                    </div>-->
                                    <!--/ko-->
                                    <!--</div>
                                    </div>-->
                                    <!--</form>-->
                                </div>
                                <!--<div class="text-center loginFooter" data-bind="visible: session.registrationsEnabled()">
                                    <span class="LoginPanelNotAMember">  Not a member? </span> <a href="#" data-bind="click: register" class="LoginPanelJoinUsNow" aria-label="Join Us Now">Join Us Now</a>
                                </div>-->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-12 px-0 bg-white py-3 brandLinks">
        <div class="container-fluid" id="loginSublinks" data-bind="with: sublinkData()">
            <div class="row LoginSubSectionText justify-content-center" data-bind="foreach : Links">
                <div class="text-center pb-3 pb-md-0"
                     data-bind="css:$root.subLinkDataCSS()">
                    <div class="center-block">
                        <a data-bind="attr:{href:Icon.TargetURL, target:Icon.Target }">
                            <img data-bind="attr:{src: 'Content/images/Brands/Icons/' + Icon.ImageURL, height:Icon.Height,width: Icon.Width, alt:HeaderText}" />
                        </a>
                    </div>
                    <div class="LoginBottomHeadText text-capitalize">
                        <span data-bind="html:HeaderText"></span>
                        <span data-bind="text:bodyText"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!--<div class="modal tabfadefix" tabindex="-1" role="dialog" id="mdLLAAgreementWithAgreeDisagree">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <div class="h6 text-center">
                    <span>You must accept the following agreement in order to access non-insured products and services</span>
                </div>
            </div>
            <div class="modal-body" style="max-height:450px;overflow:auto">
                <div data-bind="compose:'llaModule/llaPublicPage.html'"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal" data-bind="click:LLAAccepted"><i class="fa fa-check"></i> I Accept</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal" data-bind="click:LLANotAccepted"><i class="fa fa-times"></i> I Don't Accept</button>
            </div>
        </div>--><!-- /.modal-content -->
    <!--</div>--><!-- /.modal-dialog -->
<!--</div>--><!-- /.modal -->


<!--<div class="modal tabfadefix" tabindex="-1" role="dialog" id="mdSiteAnnouncements">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <div class="h6 text-left">
                    <span>Site Announcements</span>
                </div>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="max-height:450px;overflow:auto">
                <div data-bind="foreach:announcementsList()">-->
                    <!-- ko if:$data.DisplayInThisBrand()-->
                    <!--<div class="card my-1">
                        <div class="card-header">
                            <span data-bind="text:$data.Headline"></span>
                        </div>
                        <div class="card-body">
                            <p class="card-text" data-bind="text:$data.Message"></p>
                        </div>
                    </div>-->
                    <!-- /ko -->
                <!--</div>
            </div>
        </div>--><!-- /.modal-content -->
    <!--</div>--><!-- /.modal-dialog -->
<!--</div>--><!-- /.modal -->


<div class="modal tabfadefix" tabindex="-1" role="dialog" id="mdIENotSupported">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <div class="h6 text-center">
                    <span>Internet Explorer Support Ending</span>
                </div>
            </div>
            <div class="modal-body" style="max-height:450px;overflow:auto">
                <div class="row">
                    <div class="col-12">
                        Our site will no longer support Internet Explorer after January 31, 2022.
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 mt-3">
                        Please use <a href="https://www.microsoft.com/en-us/edge" class="blueLink" target="_blank">Microsoft Edge</a> or <a href="https://www.google.com/chrome/" class="blueLink" target="_blank">Google Chrome</a> to get the best experience when using our site.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">Close</span></button>
            </div>
        </div>
    </div>
</div>

<!--<div class="modal tabfadefix" tabindex="-1" role="dialog" id="mdpendingApprovals">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <div class="h6 text-center">
                    <span>Please approve registration of following customers in Administration</span>
                </div>
            </div>
            <div class="modal-body" style="max-height:450px;overflow:auto">
                <div data-bind="compose:'administration/_pendingApprovals.html'" id="dvPendingApprovals"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">Close</span></button>
            </div>
        </div>--><!-- /.modal-content -->
    <!--</div>--><!-- /.modal-dialog -->
<!--</div>--><!-- /.modal -->


<div class="modal fade" id="okatLoginModal" tabindex="-1" role="dialog" data-bind="css:{'show':showModal},style:{display:showModal()?'block':'none'}">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Login with OKTA</h5>
                <button type="button" class="close" data-bind="click:closeModal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="okta-login-container"></div>
            </div>
        </div>
    </div>
</div>
